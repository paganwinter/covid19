<html>
<head>
<title></title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: Arial;
}
.tab {
  cursor: pointer;
  border: 1px solid #DDD;
  padding: 3px;
}
.tab-selected {
  background: #EEE;
}
.tab-panel {
  display: none;
}
.tab-panel-selected {
  display: block;
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>
<script src="//d3js.org/d3.v3.min.js"></script>
</head>
<body>

<div class="tab-container">
  <div class="tabs">
    <span class="tab tab-selected">New Case Rate</span>
    <span class="tab">Death Rate</span>
  </div>
  <div class="tab-panels">
    <div class="tab-panel tab-panel-selected">
      <canvas id="graph-change-rate" width="800" height="800"></canvas>
    </div>
    <div class="tab-panel">
      <canvas id="graph-death-rate" width="800" height="500"></canvas>      
    </div>
  </div>
</div>

<div class="tab-container">
  <div class="tabs">
    <span class="tab tab-selected">Totals (Line)</span>
    <span class="tab">Totals (Bar)</span>
  </div>
  <div class="tab-panels">
    <div class="tab-panel tab-panel-selected">
      <canvas id="graph-totals-line" width="800" height="500"></canvas>
    </div>
    <div class="tab-panel">
      <canvas id="graph-totals-bar" width="800" height="500"></canvas>
    </div>
  </div>
</div>



<br />
<div>
Powered by <a href="https://www.covid19india.org">https://www.covid19india.org</a><br />
More graphs at <a href="https://aatishb.com/covidtrends">https://aatishb.com/covidtrends</a>
</div>


<script>
const optsY_position = 'right'
const optsY_ticks = { fontSize: 10 }
const optsY_gridLines = { tickMarkLength: 3 }

const optsX_gridLines = { display: false }
const optsX_ticks = {
  maxRotation: 90,
  minRotation: 90,
  autoSkip: true,
  maxTicksLimit: 20,
  fontSize: 10,
}

const optsEl_point = {
  radius: 0,
  hitRadius: 10, 
  hoverRadius: 5,
} 

async function main() {
  /*
  https://api.covid19india.org/data.json
  https://api.covid19india.org/state_district_wise.json
  https://api.covid19india.org/travel_history.json
  https://api.covid19india.org/raw_data.json

  https://raw.githubusercontent.com/covid19india/api/master/data.json
  */

  let res = await fetch('https://raw.githubusercontent.com/covid19india/api/master/data.json')
  let data = await res.json()
  console.log(data)

  let daywise = data.cases_time_series.slice(30)

  // let cases = data.cases_time_series
  // let yesterdays = cases[cases.length - 1]
  // let todays = data.key_values[0]
  let todays = data.statewise.find(i => i.state === 'Total')
  const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December' ]
  let todaysDate = todays.lastupdatedtime.split('/') // 29/03/2020 18:17:23
  todays = {
    dailyconfirmed: todays.deltaconfirmed,
    dailyrecovered: todays.deltarecovered,
    dailydeceased: todays.deltadeaths,
    date: `${todaysDate[0]} ${months[todaysDate[1] - 1]} `, // '29 March ',
    totalconfirmed: todays.confirmed,
    totalrecovered: todays.recovered,
    totaldeceased: todays.deaths,
  }
  console.log(todays)
  daywise.push(todays)

  let prevConfirmed = 0
  let prevRecovered = 0
  let prevDeceased = 0
  for (let day of daywise) {
    day.deltaconfirmed = (day.dailyconfirmed - prevConfirmed)
    day.deltarecovered = (day.dailyrecovered - prevRecovered)
    day.deltadeceased = (day.dailydeceased - prevDeceased)
    prevConfirmed = day.dailyconfirmed
    prevRecovered = day.dailyrecovered
    prevDeceased = day.dailydeceased

    day.totalactive = day.totalconfirmed - day.totalrecovered - day.totaldeceased
    day.percentactive = day.totalactive / day.totalconfirmed * 100
    day.percentrecovered = day.totalrecovered / day.totalconfirmed * 100
    day.percentdeceased = day.totaldeceased / day.totalconfirmed * 100
  }
  console.log(daywise)

  drawChange('graph-change-rate', 'confirmed')
  drawChange('graph-death-rate', 'deceased')
  function drawChange(el, dataType) {
    new Chart(document.getElementById(el), {
      type: 'bar',
      data: {
        labels: daywise.map(c => c.date.substr(0, 6)),
        datasets: [
          {
            label: "New cases",
            data: daywise.map(c => c[`daily${dataType}`]),
            type: 'line',
            pointRadius: 0,
          },
          {
            label: "Change in new cases",
            data: daywise.map(c => c[`delta${dataType}`]),
            backgroundColor: "#002244",
          },
        ]
      },
      options: {
        title: { display: true, text: `Daily new ${dataType} and change` },
        scales: {
          yAxes: [
            {
              position: optsY_position,
              ticks: optsY_ticks,
              gridLines: optsY_gridLines,
            }
          ],
          xAxes: [ { ticks: optsX_ticks } ],
        },
        elements: {
          point: optsEl_point,
        },
      },
    })
  }

  drawTotals('graph-totals-line', 'line')
  drawTotals('graph-totals-bar', 'bar')
  function drawTotals(el, type) {
    new Chart(document.getElementById(el), {
      type,
      data: {
        labels: daywise.map(c => c.date.substr(0, 6)),
        datasets: [
          {
            label: "Total Recovered",
            data: daywise.map(c => c.totalrecovered),
            backgroundColor: 'lightgreen',
          },
          {
            label: "Total Deceased",
            data: daywise.map(c => c.totaldeceased),
            backgroundColor: 'red',
          },
          {
            label: "Total Active",
            data: daywise.map(c => (c.totalactive)),
            backgroundColor: 'lightblue',
          },
        ]
      },
      options: {
        title: { display: true, text: 'Total' },
        scales: {
          xAxes: [ { ticks: optsX_ticks } ],
          yAxes: [
            {
              position: optsY_position,
              ticks: optsY_ticks,
              gridLines: optsY_gridLines,
              stacked: true,
            },
          ],
        },
        elements: {
          point: optsEl_point,
        },
      },
    })
  }

  /*
    '#ff073a',
    '#28a745',
    '#6c757d',
    '#ff073a',
    '#28a745',
    '#6c757d'
      datasets: [
        {
          label: "New cases",
          data: cases.map(c => c.dailyconfirmed),
          backgroundColor: "#002244",
          barPercentage: 0.1,
          // barThickness: 6,
          // maxBarThickness: 10,
        }
      ]
  */
}

function tab(el) {
  console.log(el)
}

window.onload = function () {
  main()
  document.querySelectorAll('.tab-container').forEach($tc => {
    let $tabs = $tc.querySelector('.tabs')
    let $panels = $tc.querySelector('.tab-panels')

    $tabs.querySelectorAll('.tab').forEach($tab => {
      $tab.addEventListener('click', function (e) {
        let i = Array.prototype.indexOf.call(e.target.parentNode.children, e.target)
        let $panel = $panels.children.item(i)
        Array.from($panels.children).forEach($p => {
          $p.classList.remove('tab-panel-selected')
        })
        $panel.classList.toggle('tab-panel-selected')

        Array.from($tabs.children).forEach($t => {
          $t.classList.remove('tab-selected')
        })
        $tab.classList.toggle('tab-selected')
      })
    })
  })
}

</script>
</body>
</html>