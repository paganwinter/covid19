<html>
<head>
<title></title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: Arial;
}
.tab {
  cursor: pointer;
  border: 1px solid #DDD;
  padding: 3px;
}
.tab-selected {
  background: #EEE;
}
.tab-panel {
  display: none;
}
.tab-panel-selected {
  display: block;
}
canvas {
  /* height: 33vh; */
  height: 1000px;
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>
<script src="//d3js.org/d3.v3.min.js"></script>
</head>
<body>

<div class="tab-container">
  <div class="tabs">
    <span class="tab tab-selected">Trend</span>
  </div>
  <div class="tab-panels">
    <div class="tab-panel tab-panel-selected">
      New cases in last 7 days vs Total number of cases
      <canvas id="graph-trend" height="1200px" width="800px"></canvas>
    </div>
  </div>
</div>

<div class="tab-container">
  <div class="tabs">
    <span class="tab tab-selected">New Case Rate</span>
    <span class="tab">Death Rate</span>
  </div>
  <div class="tab-panels">
    <div class="tab-panel tab-panel-selected">
      <canvas id="graph-change-rate" height="1000px" width="800px"></canvas>
    </div>
    <div class="tab-panel">
      <canvas id="graph-death-rate" height="1000px" width="800px"></canvas>
    </div>
  </div>
</div>

<div class="tab-container">
  <div class="tabs">
    <span class="tab tab-selected">Totals (Line)</span>
    <span class="tab">Totals (Bar)</span>
  </div>
  <div class="tab-panels">
    <div class="tab-panel tab-panel-selected">
      <canvas id="graph-totals-line" height="1000px" width="800px"></canvas>
    </div>
    <div class="tab-panel">
      <canvas id="graph-totals-bar" height="1000px" width="800px"></canvas>
    </div>
  </div>
</div>


<br />
<div>
Powered by <a href="https://www.covid19india.org">https://www.covid19india.org</a><br />
More graphs at <a href="https://aatishb.com/covidtrends">https://aatishb.com/covidtrends</a>
</div>


<script>
const proxyUrl = 'https://cors-anywhere.herokuapp.com/'
// const apiBaseUrl = 'https://raw.githubusercontent.com/covid19india/api/master'
const apiBaseUrl = 'https://api.covid19india.org'
const targetUrl = `${proxyUrl}${apiBaseUrl}`

const optsY_position = 'right'
const optsY_ticks = { fontSize: 10 }
const optsY_gridLines = { tickMarkLength: 3 }

const optsX_gridLines = { display: false }
const optsX_ticks = {
  maxRotation: 90,
  minRotation: 90,
  autoSkip: true,
  maxTicksLimit: 20,
  fontSize: 10,
}

const optsEl_point = {
  radius: 0,
  hitRadius: 10, 
  hoverRadius: 5,
} 

async function main() {
  /*
  https://api.covid19india.org/data.json
  https://api.covid19india.org/state_district_wise.json
  https://api.covid19india.org/travel_history.json
  https://api.covid19india.org/raw_data.json

  https://raw.githubusercontent.com/covid19india/api/master/data.json
  */

  let res = await fetch(`${targetUrl}/data.json`)
  let data = await res.json()
  console.log(data)

  let daywise = data.cases_time_series.slice(30)

  // let cases = data.cases_time_series
  // let yesterdays = cases[cases.length - 1]
  // let todays = data.key_values[0]
  let todays = data.statewise.find(i => i.state === 'Total')
  const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December' ]
  let todaysDate = todays.lastupdatedtime.split('/') // 29/03/2020 18:17:23
  todays = {
    dailyconfirmed: todays.deltaconfirmed,
    dailyrecovered: todays.deltarecovered,
    dailydeceased: todays.deltadeaths,
    date: `${todaysDate[0]} ${months[todaysDate[1] - 1]} `, // '29 March ',
    totalconfirmed: todays.confirmed,
    totalrecovered: todays.recovered,
    totaldeceased: todays.deaths,
  }
  // console.log(todays)
  daywise.push(todays)

  let prevConfirmed = 0
  let prevRecovered = 0
  let prevDeceased = 0
  for (let day of daywise) {
    day.deltaconfirmed = (day.dailyconfirmed - prevConfirmed)
    day.deltarecovered = (day.dailyrecovered - prevRecovered)
    day.deltadeceased = (day.dailydeceased - prevDeceased)
    prevConfirmed = day.dailyconfirmed
    prevRecovered = day.dailyrecovered
    prevDeceased = day.dailydeceased

    day.totalactive = day.totalconfirmed - day.totalrecovered - day.totaldeceased
    day.percentactive = day.totalactive / day.totalconfirmed * 100
    day.percentrecovered = day.totalrecovered / day.totalconfirmed * 100
    day.percentdeceased = day.totaldeceased / day.totalconfirmed * 100
  }
  console.log(daywise)

  drawChange('graph-change-rate', 'confirmed')
  drawChange('graph-death-rate', 'deceased')
  function drawChange(el, dataType) {
    new Chart(document.getElementById(el), {
      type: 'bar',
      data: {
        labels: daywise.map(c => c.date.substr(0, 6)),
        datasets: [
          {
            label: "New cases",
            data: daywise.map(c => c[`daily${dataType}`]),
            type: 'line',
            pointRadius: 0,
          },
          {
            label: "Change in new cases",
            data: daywise.map(c => c[`delta${dataType}`]),
            backgroundColor: "#002244",
          },
        ]
      },
      options: {
        title: { display: true, text: `Daily new ${dataType} and change` },
        scales: {
          yAxes: [
            {
              position: optsY_position,
              ticks: optsY_ticks,
              gridLines: optsY_gridLines,
            }
          ],
          xAxes: [ { ticks: optsX_ticks } ],
        },
        elements: {
          point: optsEl_point,
        },
      },
    })
  }

  drawTotals('graph-totals-line', 'line')
  drawTotals('graph-totals-bar', 'bar')
  function drawTotals(el, type) {
    new Chart(document.getElementById(el), {
      type,
      data: {
        labels: daywise.map(c => c.date.substr(0, 6)),
        datasets: [
          {
            label: "Total Recovered",
            data: daywise.map(c => c.totalrecovered),
            backgroundColor: 'lightgreen',
          },
          {
            label: "Total Deceased",
            data: daywise.map(c => c.totaldeceased),
            backgroundColor: 'red',
          },
          {
            label: "Total Active",
            data: daywise.map(c => (c.totalactive)),
            backgroundColor: 'lightblue',
          },
        ]
      },
      options: {
        title: { display: true, text: 'Total' },
        scales: {
          xAxes: [ { ticks: optsX_ticks } ],
          yAxes: [
            {
              position: optsY_position,
              ticks: optsY_ticks,
              gridLines: optsY_gridLines,
              stacked: true,
            },
          ],
        },
        elements: {
          point: optsEl_point,
        },
      },
    })
  }

  /*
    '#ff073a',
    '#28a745',
    '#6c757d',
    '#ff073a',
    '#28a745',
    '#6c757d'
      datasets: [
        {
          label: "New cases",
          data: cases.map(c => c.dailyconfirmed),
          backgroundColor: "#002244",
          barPercentage: 0.1,
          // barThickness: 6,
          // maxBarThickness: 10,
        }
      ]
  */
}

function tab(el) {
  console.log(el)
}

window.onload = function () {
  main()
  test()

  document.querySelectorAll('.tab-container').forEach($tc => {
    let $tabs = $tc.querySelector('.tabs')
    let $panels = $tc.querySelector('.tab-panels')

    $tabs.querySelectorAll('.tab').forEach($tab => {
      $tab.addEventListener('click', function (e) {
        let i = Array.prototype.indexOf.call(e.target.parentNode.children, e.target)
        let $panel = $panels.children.item(i)
        Array.from($panels.children).forEach($p => {
          $p.classList.remove('tab-panel-selected')
        })
        $panel.classList.toggle('tab-panel-selected')

        Array.from($tabs.children).forEach($t => {
          $t.classList.remove('tab-selected')
        })
        $tab.classList.toggle('tab-selected')
      })
    })
  })
}


async function test() {
  /*
  let res = await fetch('https://raw.githubusercontent.com/covid19india/api/master/state_test_data.json')
  let state_test_data = await res.json()
  state_test_data = state_test_data.states_tested_data
  let testsByState = {}
  for (let i of state_test_data) {
    let { state, updatedon: date, totaltested: total, negative, positive, unconfirmed } = i
    total = parseInt(total)
    positive = parseInt(positive)
    negative = parseInt(negative)
    unconfirmed = parseInt(unconfirmed)
    let dateParts = date.split('/')
    date = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`
    percentPos = (positive/total*100).toFixed(2)

    testsByState[state] = testsByState[state] || {}
    // testsByState[state][date] = { total, positive, percentPos, negative, unconfirmed }
    testsByState[state] = { total, positive, percentPos, negative, unconfirmed }
    // console.log(state, date, testsByState[state])
  }
  console.log(testsByState)
  */

  const randomColor = function() {
    var r = Math.floor(Math.random() * 255)
    var g = Math.floor(Math.random() * 255)
    var b = Math.floor(Math.random() * 255)
    return `rgb(${r} , ${g}, ${b})`
  }

  const stateMap = {
    ka: { color: 'rgb(136 , 253, 58)', name: 'Karnataka' },
    mh: { color: 'rgb(243 , 15, 16)', name: 'Maharashtra' },
    kl: { color: 'rgb(13 , 176, 206)', name: 'Kerala' },

    an: { color: '', name: 'Andaman and Nicobar', hidden: true },
    ap: { color: '#31393C', name: 'Andhra Pradesh' },
    ar: { color: '', name: 'Arunachal Pradesh', hidden: true },
    as: { color: '', name: 'Assam', hidden: true },
    br: { color: '', name: 'Bihar', hidden: false },
    ch: { color: '', name: 'Chandigarh', hidden: true },
    ct: { color: '', name: 'Chhattisgarh', hidden: true },
    dd: { color: '', name: 'Daman and Diu', hidden: true },
    dl: { color: '', name: 'Delhi' },
    dn: { color: '', name: 'Dadra and Nagar Haveli', hidden: true },
    ga: { color: '', name: 'Goa', hidden: true },
    gj: { color: '', name: 'Gujarat', hidden: true },
    hp: { color: '', name: 'Himachal Pradesh', hidden: true },
    hr: { color: '', name: 'Haryana', hidden: true },
    jh: { color: '', name: 'Jharkhand', hidden: true },
    jk: { color: '', name: 'Jammu and Kashmir', hidden: true },
    la: { color: '', name: 'Ladakh', hidden: true },
    ld: { color: '', name: 'Lakshadweep', hidden: true },
    ml: { color: '', name: 'Meghalaya', hidden: true },
    mn: { color: '', name: 'Manipur', hidden: true },
    mp: { color: 'rgb(115 , 161, 62)', name: 'Madhya Pradesh', hidden: true },
    mz: { color: '', name: 'Mizoram', hidden: true },
    nl: { color: '', name: 'Nagaland', hidden: true },
    or: { color: '', name: 'Odisha', hidden: true },
    pb: { color: '', name: 'Punjab', hidden: true },
    py: { color: '', name: 'Puducherry', hidden: true },
    rj: { color: '', name: 'Rajasthan', hidden: true },
    sk: { color: '', name: 'Sikkim', hidden: true },
    tg: { color: '', name: 'Telangana' },
    tn: { color: 'rgb(229 , 169, 47)', name: 'Tamil Nadu' },
    tr: { color: '', name: 'Tripura', hidden: true },
    up: { color: '', name: 'Uttar Pradesh', hidden: true },
    ut: { color: '', name: 'Uttarakhand', hidden: true },
    wb: { color: '', name: 'West Bengal', hidden: true },
    tt: { color: '', name: 'Total' },
  }
  res = await fetch(`${targetUrl}/states_daily.json`)
  let { states_daily } = await res.json()
  console.log(states_daily)
  let datasets = []
  let test = {}
  states_daily = states_daily.filter(d => d.status === 'Confirmed')
  for (let i of states_daily) {
    // console.log(i)
    let { date } = i
    Object.keys(stateMap).forEach(st => {
      test[st] = test[st] || []
      test[st].push({
        date,
        daily: parseInt(i[st])
      })
    })
  }
  console.log(test)


  for (let st in test) {
    if (stateMap[st].skip) continue

    let stateData = test[st]
    let stateName = stateMap[st].name
    let dailyCount = stateData.map(i => i.daily)
    if (dailyCount.reduce((a, b) => (a + b), 0) < 100) continue

    let data = []
    let dailyAggr = 0
    let newCasesInNDays = 0
    const N = 7
    const color = stateMap[st].color || randomColor()

    for (let i = 0; i < dailyCount.length; i++) {
      let cnt = dailyCount[i]
      dailyAggr += cnt
      let lastNDays = dailyCount.slice(Math.max(i+1 - N, 0), i+1)
      newCasesInNDays = lastNDays.reduce((a, b) => (a + b), 0)
      if (dailyAggr > 0) data.push({ x: dailyAggr, y: newCasesInNDays })
      // data[dailyAggr] = newCasesInNDays
      console.log(stateName, i, cnt, lastNDays, dailyAggr, newCasesInNDays)
    }
    datasets.push({
      label: stateMap[st].name || st,
      borderColor: color,
      hidden: stateMap[st].hidden,
      backgroundColor: Chart.helpers.color(color).alpha(0.5).rgbString(),
      showLine: true,
      fill: false,
      pointRadius: 2,
      data,
    })
  }

  console.log(datasets)

  let trendData = {
    // labels: Array.from(Array(1000).keys()), // x axis points
    datasets,
  }
  let trendOpts = {
    responsive: true,
    scales: {
      xAxes: [
        {
          type: 'logarithmic',
          position: 'bottom',
          ticks: {
            userCallback: function(tick) {
              var remain = tick / (Math.pow(10, Math.floor(Chart.helpers.log10(tick))))
              if (remain === 1 || remain === 2 || remain === 5) {
                if (tick >= 1000) return tick/1000 + 'k'
                return tick.toString()
              }
              return ''
            },
          },
          scaleLabel: {
            // labelString: 'Frequency',
            // display: true,
          },
        }
      ],
      yAxes: [
        {
          type: 'logarithmic',
          ticks: {
            userCallback: function(tick) {
              var remain = tick / (Math.pow(10, Math.floor(Chart.helpers.log10(tick))))
              if (remain === 1 || remain === 2 || remain === 5) {
                if (tick >= 1000) return tick/1000 + 'k'
                return tick.toString()
              }
              return ''
            },
          },
          scaleLabel: {
            // labelString: 'Frequency',
            // display: true,
          },
        },
      ],
    },
    tooltips: {
      callbacks: {
        title: function(tooltipItem, data) {
          console.log(tooltipItem, data)
          console.log(tooltipItem[0].datasetIndex, data.datasets[tooltipItem[0].datasetIndex])
          return data.datasets[tooltipItem[0].datasetIndex].label
        },
        // label: function(tooltipItem, data) {
        //   return data['datasets'][0]['data'][tooltipItem['index']];
        // },
        // afterLabel: function(tooltipItem, data) {
        //   var dataset = data['datasets'][0];
        //   var percent = Math.round((dataset['data'][tooltipItem['index']] / dataset["_meta"][0]['total']) * 100)
        //   return '(' + percent + '%)';
        // }
      },
      // backgroundColor: '#FFF',
      titleFontSize: 16,
      // titleFontColor: '#0066ff',
      // bodyFontColor: '#000',
      bodyFontSize: 14,
      // displayColors: false,
    }
  }
  let trendChart = new Chart(document.getElementById('graph-trend'), {
    type: 'scatter',
    data: trendData,
    options: trendOpts,
  });
}
</script>
</body>
</html>