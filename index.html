<html>
<head>
<title></title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: Arial;
}
.tab {
  cursor: pointer;
  border: 1px solid #DDD;
  padding: 3px;
}
.tab-selected {
  background: #EEE;
}
.tab-panel {
  display: none;
}
.tab-panel-selected {
  display: block;
}
canvas {
  /* height: 33vh; */
  height: 1000px;
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>
<!-- <script src="https://d3js.org/d3.v3.min.js"></script> -->
</head>
<body>

<div class="tab-container">
  <div class="tabs">
    <span class="tab tab-selected">New Case Rate</span>
    <span class="tab">Death Rate</span>
  </div>
  <div class="tab-panels">
    <div class="tab-panel tab-panel-selected">
      <canvas id="graph-change-rate" height="800px" width="800px"></canvas>
    </div>
    <div class="tab-panel">
      <canvas id="graph-death-rate" height="800px" width="800px"></canvas>
    </div>
  </div>
</div>

<div class="tab-container">
  <div class="tabs">
    <span class="tab tab-selected">Bangalore</span>
    <span class="tab">Bombay</span>
  </div>
  <div class="tab-panels">
    <div class="tab-panel tab-panel-selected">
      <canvas id="graph-district-bangalore" height="800px" width="800px"></canvas>
    </div>
    <div class="tab-panel">
      <canvas id="graph-district-bombay" height="800px" width="800px"></canvas>
    </div>
  </div>
</div>


<div class="tab-container">
  <div class="tabs">
    <span class="tab tab-selected">Trend</span>
  </div>
  <div class="tab-panels">
    <div class="tab-panel tab-panel-selected">
      New cases in last 7 days vs Total number of cases
      <canvas id="graph-trend" height="1200px" width="800px"></canvas>
    </div>
  </div>
</div>


<div class="tab-container">
  <div class="tabs">
    <span class="tab tab-selected">Totals</span>
    <span class="tab">Percentage</span>
  </div>
  <div class="tab-panels">
    <div class="tab-panel tab-panel-selected">
      <canvas id="graph-totals-line" height="800px" width="800px"></canvas>
    </div>
    <div class="tab-panel">
      <canvas id="graph-totals-bar" height="800px" width="800px"></canvas>
    </div>
  </div>
</div>


<br />
<div>
Powered by <a href="https://www.covid19india.org">https://www.covid19india.org</a><br />
More graphs at <a href="https://aatishb.com/covidtrends">https://aatishb.com/covidtrends</a>
</div>


<script>
/*
https://api.covid19india.org/data.json
https://api.covid19india.org/state_district_wise.json
https://api.covid19india.org/travel_history.json
https://api.covid19india.org/raw_data.json

https://raw.githubusercontent.com/covid19india/api/master/data.json
*/

const proxyUrl = 'https://cors-anywhere.herokuapp.com/'
// const apiBaseUrl = 'https://raw.githubusercontent.com/covid19india/api/master'
const apiBaseUrl = 'https://api.covid19india.org'
const targetUrl = `${proxyUrl}${apiBaseUrl}`



const optsY_position = 'right'
const optsY_ticks = { fontSize: 10 }
const optsY_gridLines = { tickMarkLength: 3 }

const optsX_gridLines = { display: false }
const optsX_ticks = {
  maxRotation: 90,
  minRotation: 90,
  autoSkip: true,
  maxTicksLimit: 20,
  fontSize: 10,
}
const optsEl_point = {
  radius: 0,
  hitRadius: 10, 
  hoverRadius: 5,
} 


async function main({ cases_time_series, statewise }) {
  let daywise = cases_time_series.slice(30)

  // let cases = data.cases_time_series
  // let yesterdays = cases[cases.length - 1]
  // let todays = data.key_values[0]
  let todays = statewise.find(i => i.state === 'Total')
  const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December' ]
  let todaysDate = todays.lastupdatedtime.split('/') // 29/03/2020 18:17:23
  todays = {
    dailyconfirmed: todays.deltaconfirmed,
    dailyrecovered: todays.deltarecovered,
    dailydeceased: todays.deltadeaths,
    date: `${todaysDate[0]} ${months[todaysDate[1] - 1]} `, // '29 March ',
    totalconfirmed: todays.confirmed,
    totalrecovered: todays.recovered,
    totaldeceased: todays.deaths,
    today: true,
  }
  // console.log(todays)
  daywise.push(todays)

  let prevConfirmed = 0
  let prevRecovered = 0
  let prevDeceased = 0
  for (let day of daywise) {
    day.deltaconfirmed = (day.dailyconfirmed - prevConfirmed)
    day.deltarecovered = (day.dailyrecovered - prevRecovered)
    day.deltadeceased = (day.dailydeceased - prevDeceased)
    prevConfirmed = day.dailyconfirmed
    prevRecovered = day.dailyrecovered
    prevDeceased = day.dailydeceased
    if (day.today) {
      day.deltaconfirmed = 0
      day.deltarecovered = 0
      day.deltadeceased = 0
    }

    day.totalactive = day.totalconfirmed - day.totalrecovered - day.totaldeceased
    day.percentactive = day.totalactive / day.totalconfirmed * 100
    day.percentrecovered = day.totalrecovered / day.totalconfirmed * 100
    day.percentdeceased = day.totaldeceased / day.totalconfirmed * 100
  }
  for (let i = 0; i < daywise.length; i++) {
    const N = 3
    let lastNDays = daywise.slice(Math.max(i+1 - N, 0), i+1)
    let avgNewCases = lastNDays.reduce((acc, item) => {
      return (parseInt(acc) + parseInt(item.dailyconfirmed))
    }, 0)
    // console.log(avgNewCases, avgNewCases / N)
    avgNewCases = avgNewCases / N
    daywise[i].avgDailyNew = avgNewCases
  }

  console.log(daywise)

  drawChange('graph-change-rate', 'confirmed')
  drawChange('graph-death-rate', 'deceased')
  function drawChange(el, dataType) {
    new Chart(document.getElementById(el), {
      type: 'bar',
      data: {
        labels: daywise.map(c => c.date.substr(0, 6)),
        datasets: [
          {
            label: "New cases",
            data: daywise.map(c => c[`daily${dataType}`]),
            type: 'line',
            pointRadius: 1,
          },
          {
            label: "Change in new cases",
            data: daywise.map(c => c[`delta${dataType}`]),
            backgroundColor: "#002244",
          },
        ]
      },
      options: {
        title: { display: true, text: `Daily new ${dataType} and change` },
        scales: {
          yAxes: [
            {
              position: optsY_position,
              ticks: optsY_ticks,
              gridLines: optsY_gridLines,
            }
          ],
          xAxes: [ { ticks: optsX_ticks } ],
        },
        elements: {
          point: optsEl_point,
        },
      },
    })
  }

  drawTotals('graph-totals-line', 'line')
  drawTotalsPercentage('graph-totals-bar')
  function drawTotals(el, type) {
    new Chart(document.getElementById(el), {
      type,
      data: {
        labels: daywise.map(c => c.date.substr(0, 6)),
        datasets: [
          {
            label: "Total Active",
            data: daywise.map(c => (c.totalactive)),
            backgroundColor: 'lightblue',
          },
          {
            label: "Total Recovered",
            data: daywise.map(c => c.totalrecovered),
            backgroundColor: 'lightgreen',
          },
          {
            label: "Total Deceased",
            data: daywise.map(c => c.totaldeceased),
            backgroundColor: 'red',
          },
        ]
      },
      options: {
        title: { display: true, text: 'Total' },
        scales: {
          xAxes: [ { ticks: optsX_ticks } ],
          yAxes: [
            {
              position: optsY_position,
              ticks: optsY_ticks,
              gridLines: optsY_gridLines,
              stacked: true,
            },
          ],
        },
        elements: {
          point: optsEl_point,
        },
      },
    })
  }
  function drawTotalsPercentage(el) {
    new Chart(document.getElementById(el), {
      type:  'bar',
      data: {
        labels: daywise.map(c => c.date.substr(0, 6)),
        datasets: [
          {
            label: "Percent Active",
            data: daywise.map(c => (c.percentactive)),
            backgroundColor: 'lightblue',
          },
          {
            label: "Percent Recovered",
            data: daywise.map(c => c.percentrecovered),
            backgroundColor: 'lightgreen',
          },
          {
            label: "Percent Deceased",
            data: daywise.map(c => c.percentdeceased),
            backgroundColor: 'red',
          },
        ]
      },
      options: {
        title: { display: true, text: 'Total' },
        scales: {
          xAxes: [ { ticks: optsX_ticks } ],
          yAxes: [
            {
              position: optsY_position,
              ticks: optsY_ticks,
              gridLines: optsY_gridLines,
              stacked: true,
            },
          ],
        },
        elements: {
          point: optsEl_point,
        },
      },
    })
  }
}

// function tab(el) { console.log(el) }

function o2a(obj) {
  return Object.keys(obj).map(key => obj[key])
}

async function growthTrend(data) {
  let datasets = []

  for (let st in data) {
    let state = data[st]
    if (state.confirmed.total < 100) continue
    // let dailyCount = o2a(state.confirmed.daily)
    let dailyCount = state.confirmed.dailyArr.map(i => i.count)

    let plotData = []
    let dailyAggr = 0
    let newCasesInNDays = 0
    const N = 7

    for (let i = 0; i < dailyCount.length; i++) {
      let cnt = dailyCount[i]
      dailyAggr += cnt
      let lastNDays = dailyCount.slice(Math.max(i+1 - N, 0), i+1)
      newCasesInNDays = lastNDays.reduce((a, b) => (a + b), 0)
      if (dailyAggr > 0) plotData.push({ x: dailyAggr, y: newCasesInNDays })
    }

    let color = state.color || randomColor()
    datasets.push({
      label: state.name,
      borderColor: color,
      hidden: stateMap[st].hidden,

      backgroundColor: Chart.helpers.color(color).alpha(0.5).rgbString(),
      showLine: true,
      fill: false,
      pointRadius: 1,
      data: plotData,
    })
  }

  let trendData = {
    datasets,
  }
  let trendOpts = {
    responsive: true,
    scales: {
      xAxes: [
        {
          type: 'logarithmic',
          position: 'bottom',
          ticks: {
            userCallback: function(tick) {
              var remain = tick / (Math.pow(10, Math.floor(Chart.helpers.log10(tick))))
              if (remain === 1 || remain === 2 || remain === 5) {
                if (tick >= 1000) return tick/1000 + 'k'
                return tick.toString()
              }
              return ''
            },
          },
          scaleLabel: {
            // labelString: 'Frequency',
            // display: true,
          },
        }
      ],
      yAxes: [
        {
          type: 'logarithmic',
          ticks: {
            userCallback: function(tick) {
              var remain = tick / (Math.pow(10, Math.floor(Chart.helpers.log10(tick))))
              if (remain === 1 || remain === 2 || remain === 5) {
                if (tick >= 1000) return tick/1000 + 'k'
                return tick.toString()
              }
              return ''
            },
          },
          scaleLabel: {
            // labelString: 'Frequency',
            // display: true,
          },
        },
      ],
    },
    tooltips: {
      callbacks: {
        title: function(tooltipItem, data) {
          console.log(tooltipItem, data)
          console.log(tooltipItem[0].datasetIndex, data.datasets[tooltipItem[0].datasetIndex])
          return data.datasets[tooltipItem[0].datasetIndex].label
        },
        // label: function(tooltipItem, data) {
        //   return data['datasets'][0]['data'][tooltipItem['index']];
        // },
        // afterLabel: function(tooltipItem, data) {
        //   var dataset = data['datasets'][0];
        //   var percent = Math.round((dataset['data'][tooltipItem['index']] / dataset["_meta"][0]['total']) * 100)
        //   return '(' + percent + '%)';
        // }
      },
      // backgroundColor: '#FFF',
      titleFontSize: 16,
      // titleFontColor: '#0066ff',
      // bodyFontColor: '#000',
      bodyFontSize: 14,
      // displayColors: false,
    }
  }
  let trendChart = new Chart(document.getElementById('graph-trend'), {
    type: 'scatter',
    data: trendData,
    options: trendOpts,
  });
}

function districtTimeseries(el, masterData, st, district, type) {
  let distType = masterData[st].districtWise[district][type]
  let dates = Object.keys(distType.aggr)
  let totalConfirmed = Object.keys(distType.aggr).map(dt => distType.aggr[dt])
  let dailyConfirmed = Object.keys(distType.daily).map(dt => distType.daily[dt])

  new Chart(document.getElementById(el), {
    type: 'bar',
    data: {
      labels: dates,
      datasets: [
        {
          label: 'Total Confirmed',
          data: totalConfirmed,
          type: 'line',
          yAxisID: 'totalConfirmed',
          pointRadius: 1,
        },
        {
          label: "Daily Confirmed",
          data: dailyConfirmed,
          yAxisID: 'dailyConfirmed',
          backgroundColor: "#002244",
        },
      ]
    },
    options: {
      title: { display: true, text: `Total and Daily confirmed` },
      scales: {
        yAxes: [
          {
            id: 'totalConfirmed',
            position: 'left',
            // ticks: optsY_ticks,
            ticks: { min: 0 },
            gridLines: optsY_gridLines,
          },
          {
            id: 'dailyConfirmed',
            position: 'right',
            ticks: optsY_ticks,
            // gridLines: optsY_gridLines,
          }
        ],
        xAxes: [
          {
            ticks: optsX_ticks
          }
        ],
      },
      elements: {
        point: optsEl_point,
      },
    },
  })
}

function getDateList(start, end) {
  let arr = []
  let dt = new Date(start)
  end = end || new Date()

  while (dt <= end) {
    arr.push(dateToStr(new Date(dt)))
    dt.setDate(dt.getDate() + 1)
  }

  return arr
}

const randomColor = function() {
  var r = Math.floor(Math.random() * 255)
  var g = Math.floor(Math.random() * 255)
  var b = Math.floor(Math.random() * 255)
  return `rgb(${r} , ${g}, ${b})`
}

async function getData(dataElement) {
  let data = await fetch(`${targetUrl}/${dataElement}.json`).then(res => res.json())
  return data
}

function stFromState(stateName) {
  for (let st in stateMap) {
    if (stateName === stateMap[st].name) {
      return st
    }
  }
  console.log('stFromState: could not find state code (st) for state name', stateName)
}

function dateToStr(date) {
  let month = '' + (date.getMonth() + 1)
  let day = '' + date.getDate()
  let year = date.getFullYear()

  if (month.length < 2) month = '0' + month
  if (day.length < 2) day = '0' + day

  return [year, month, day].join('-')
}

const START_DATE = '2020-01-30'
const dateList = getDateList(START_DATE)

const stateMap = {
  ka: { color: 'rgb(136 , 253, 58)', name: 'Karnataka' },
  mh: { color: 'rgb(243 , 15, 16)', name: 'Maharashtra' },
  kl: { color: 'rgb(13 , 176, 206)', name: 'Kerala' },

  an: { color: '', name: 'Andaman and Nicobar Islands', hidden: true },
  ap: { color: '#31393C', name: 'Andhra Pradesh' },
  ar: { color: '', name: 'Arunachal Pradesh', hidden: true },
  as: { color: '', name: 'Assam', hidden: true },
  br: { color: '', name: 'Bihar', hidden: false },
  ch: { color: '', name: 'Chandigarh', hidden: true },
  ct: { color: '', name: 'Chhattisgarh', hidden: true },
  dd: { color: '', name: 'Daman and Diu', hidden: true },
  dl: { color: '', name: 'Delhi' },
  dn: { color: '', name: 'Dadra and Nagar Haveli', hidden: true },
  ga: { color: '', name: 'Goa', hidden: true },
  gj: { color: '', name: 'Gujarat', hidden: true },
  hp: { color: '', name: 'Himachal Pradesh', hidden: true },
  hr: { color: '', name: 'Haryana', hidden: true },
  jh: { color: '', name: 'Jharkhand', hidden: true },
  jk: { color: '', name: 'Jammu and Kashmir', hidden: true },
  la: { color: '', name: 'Ladakh', hidden: true },
  ld: { color: '', name: 'Lakshadweep', hidden: true },
  ml: { color: '', name: 'Meghalaya', hidden: true },
  mn: { color: '', name: 'Manipur', hidden: true },
  mp: { color: 'rgb(115 , 161, 62)', name: 'Madhya Pradesh', hidden: true },
  mz: { color: '', name: 'Mizoram', hidden: true },
  nl: { color: '', name: 'Nagaland', hidden: true },
  or: { color: '', name: 'Odisha', hidden: true },
  pb: { color: '', name: 'Punjab', hidden: true },
  py: { color: '', name: 'Puducherry', hidden: true },
  rj: { color: '', name: 'Rajasthan', hidden: true },
  sk: { color: '', name: 'Sikkim', hidden: true },
  tg: { color: '', name: 'Telangana' },
  tn: { color: 'rgb(229 , 169, 47)', name: 'Tamil Nadu' },
  tr: { color: '', name: 'Tripura', hidden: true },
  up: { color: '', name: 'Uttar Pradesh', hidden: true },
  ut: { color: '', name: 'Uttarakhand', hidden: true },
  wb: { color: '', name: 'West Bengal', hidden: true },
  tt: { color: '', name: 'Total' },
}



function processData({ statewise, states_daily, states_tested_data, districtsDaily }) {
  let byState = {}

  Object.keys(stateMap).forEach(st => {
    byState[st] = {
      name: stateMap[st].name,
      color: stateMap[st].color,
      confirmed: {
        total: 0,
        daily: {},
        dailyArr: [],
      },
      recovered: {
        total: 0,
        percent: 0,
        daily: {},
        dailyArr: [],
      },
      deceased: {
        total: 0,
        percent: 0,
        daily: {},
        dailyArr: [],
      },
      active: {
        total: 0,
        percent: 0,
        daily: {},
        dailyArr: [],
      },
      tests: {},
      testsArr: [],
      districtWise: {},
    }
  })

  for (let item of states_daily) {
    let { date, status } = item
    date = dateToStr(new Date(date))
    status = status.toLowerCase()
    Object.keys(stateMap).forEach(st => {
      let count = parseInt(item[st])

      // byState[st][status].daily[date] = { date, count }
      byState[st][status].daily[date] = count
      byState[st][status].dailyArr.push({ date, count })
    })
  }

  for (let item of statewise) {
    let { statecode, confirmed, recovered, deaths: deceased, active } = item
    let st = statecode.toLowerCase()
    confirmed = parseInt(confirmed)
    recovered = parseInt(recovered)
    deceased = parseInt(deceased)
    active = parseInt(active)

    byState[st].confirmed.total = confirmed
    byState[st].recovered.total = recovered
    byState[st].deceased.total = deceased
    byState[st].active.total = active

    byState[st].confirmed.percent = 100
    byState[st].recovered.percent = parseFloat((recovered / confirmed * 100).toFixed(2))
    byState[st].deceased.percent = parseFloat((deceased / confirmed * 100).toFixed(2))
    byState[st].active.percent = parseFloat((active / confirmed * 100).toFixed(2))
  }

  let testsByState = {}
  for (let i of states_tested_data) {
    let { state, updatedon, totaltested: total, negative, positive, unconfirmed } = i
    total = parseInt(total)
    positive = parseInt(positive)
    negative = parseInt(negative)
    unconfirmed = parseInt(unconfirmed)
    let st = stFromState(state)
    let dateParts = updatedon.split('/')
    date = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`

    // console.log(st, total, positive, negative, unconfirmed, date)
    // byState[st].tests.push({ date, total, positive, negative, unconfirmed })
    byState[st].tests[date] = { date, total, positive, negative, unconfirmed }
    byState[st].testsArr.push({ date, total, positive, negative, unconfirmed })
  }

  for (let stateName in districtsDaily) {
    let state = districtsDaily[stateName]
    let st = stFromState(stateName)

    if (!byState[st]) {
      console.log('cannot find state', stateName, ' (present in districtsDaily)')
      continue
    }

    for (let districtName in state) {
      let districtArr = state[districtName]
      byState[st].districtWise[districtName] = {
        confirmed: {
          daily: {},
          aggr: {},
        },
      }

      for (let i = 0; i < districtArr.length; i++) {
        dayData = districtArr[i]
        let { date, confirmed, active, recovered, deceased } = dayData
        date = dateToStr(new Date(date))
        byState[st].districtWise[districtName].confirmed.aggr[date] = districtArr[i].confirmed
        if (i > 0) byState[st].districtWise[districtName].confirmed.daily[date] = districtArr[i].confirmed - districtArr[i-1].confirmed
      }
    }
  }

  for (let st in byState) {
    let state = byState[st]
    console.log(
      state.name,
      state.confirmed.total,
      `${state.active.total} (${state.active.percent})`,
      `${state.recovered.total} (${state.recovered.percent})`,
      `${state.deceased.total} (${state.deceased.percent})`,
    )
  }
  return byState
}


window.onload = async function () {
  // TODO
  // Statewise table of:
  // confirmed / tested * 100
  // % active, recovered, deceased
  // change in confirmed/tested

  let promiseHolder
  try {
    promiseHolder = await Promise.all([
      getData('data'),
      getData('states_daily'),
      getData('state_test_data'),
      getData('districts_daily'),
    ])
  } catch (err) {
    alert('Error getting data:' + err.message)
  }

  let [
    { cases_time_series, statewise, tested },
    { states_daily },
    { states_tested_data },
    { districtsDaily },
  ] = promiseHolder
  console.log(districtsDaily)
  let bangalore = districtsDaily.Karnataka['Bengaluru Urban']
  console.log(bangalore)

  // cases_time_series: array of day-wise daily and cumulative country-wide stats
  // statewise: array of state-wise totals as of today, with delta over earlier day
  // tested: array of day-wise country-wide test data
  // states_daily: array of daily state-wise stats
  // states_tested_data: 

  // console.log(cases_time_series, statewise, tested)
  // console.log(states_daily)
  // console.log(states_tested_data)

  let data = processData({ statewise, states_daily, states_tested_data, districtsDaily })
  console.log(data)
  console.log(data.ka.districtWise['Bengaluru Urban'].confirmed.aggr)

  growthTrend(data)
  main({ cases_time_series, statewise })
  districtTimeseries('graph-district-bangalore', data, 'ka', 'Bengaluru Urban', 'confirmed')
  districtTimeseries('graph-district-bombay', data, 'mh', 'Mumbai', 'confirmed')

  // enable tab behaviour
  document.querySelectorAll('.tab-container').forEach($tc => {
    let $tabs = $tc.querySelector('.tabs')
    let $panels = $tc.querySelector('.tab-panels')

    $tabs.querySelectorAll('.tab').forEach($tab => {
      $tab.addEventListener('click', function (e) {
        let i = Array.prototype.indexOf.call(e.target.parentNode.children, e.target)
        let $panel = $panels.children.item(i)
        Array.from($panels.children).forEach($p => {
          $p.classList.remove('tab-panel-selected')
        })
        $panel.classList.toggle('tab-panel-selected')

        Array.from($tabs.children).forEach($t => {
          $t.classList.remove('tab-selected')
        })
        $tab.classList.toggle('tab-selected')
      })
    })
  })
}


</script>
</body>
</html>